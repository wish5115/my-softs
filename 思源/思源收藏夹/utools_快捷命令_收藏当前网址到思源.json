{
    "program": "html",
    "features": {
        "icon": "data:image/png;base64,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",
        "explain": "收藏当前网址到思源",
        "platform": [
            "win32",
            "linux",
            "darwin"
        ],
        "mainPush": false,
        "cmds": [
            "收藏当前网址到思源",
            "收藏网址配置",
            "收藏网址搜索",
            {
                "type": "window",
                "match": {
                    "app": [
                        "chrome.exe",
                        "firefox.exe",
                        "MicrosoftEdge.exe",
                        "iexplore.exe",
                        "opera.exe",
                        "brave.exe",
                        "msedge.exe",
                        "Google Chrome.app",
                        "Safari.app",
                        "Opera.app",
                        "Vivaldi.app",
                        "Brave Browser.app",
                        "Microsoft Edge.app",
                        "SiYuan.app",
                        "SiYuan.exe"
                    ]
                },
                "label": "收藏当前网址到思源"
            },
            {
                "type": "over",
                "label": "收藏当前网址到思源"
            }
        ],
        "mainHide": false,
        "code": "key_b0494300"
    },
    "output": "html",
    "tags": [
        "思源",
        "浏览器",
        "工具"
    ],
    "cmd": "<!DOCTYPE html>\n<html lang=\"zh\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>网址收藏</title>\n  <script>\n    //////////////// 参数配置 ////////////////\n    // 快捷命令服务地址\n    const quickCommandServerUrl = 'http://127.0.0.1:33442';\n    // 字段名映射，如果你字段改名了，需要在这里做调整\n    const colsMaps = {\n      link: '网址',\n      tags: '标签',\n      description: '摘要',\n      note: '备注',\n      linkTitle: '链接标题',\n      linkUrl: '链接地址',\n    };\n    // 收藏页面指令名\n    const commandName = '收藏当前网址到思源';\n    // 配置页面指令名\n    const commandConfigName = '收藏网址配置';\n    // 搜索页面指令名\n    const commandSearchName = '收藏网址搜索';\n    // 搜索框内容为空时，默认显示的topN数量\n    const defaultTopN = 10;\n  </script>\n  <style>\n    body {\n      font-family: Arial, sans-serif;\n      background-color: #f5f5f5;\n      padding: 10px;\n      margin: 0;\n      margin-top: -10px;\n      min-height: 200px;\n    }\n\n    .form-container {\n      max-width: 600px;\n      margin: 0 auto;\n      background-color: white;\n      padding: 20px;\n      border-radius: 8px;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n    }\n\n    .form-group {\n      margin-bottom: 15px;\n    }\n\n    #myForm .form-group:last-of-type {\n      margin-bottom: 10px;\n    }\n\n    #settings .form-group:last-of-type {\n      margin-bottom: 5px;\n    }\n\n    label {\n      display: block;\n      margin-bottom: 5px;\n      font-weight: bold;\n      color: #333;\n    }\n\n    input[type=\"text\"],\n    input[type=\"url\"],\n    input[type=\"password\"],\n    textarea {\n      width: 100%;\n      padding: 6px;\n      border: 1px solid #ccc;\n      border-radius: 4px;\n      box-sizing: border-box;\n      font-size: 16px;\n    }\n\n    textarea {\n      height: 50px;\n      resize: vertical;\n    }\n\n    .btn-save,\n    .btn-delete,\n    .btn-cancel,\n    .btn-label-select {\n      color: white;\n      padding: 10px 20px;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 16px;\n      margin-top: 10px;\n    }\n\n    .btn-label-select {\n      padding: 7px 20px;\n    }\n\n    .btn-save {\n      background-color: #4285f5;\n    }\n\n    .btn-save:hover {\n      background-color: #3367d6;\n    }\n\n    .btn-delete {\n      float: right;\n      background-color: #e74c3c;\n    }\n\n    .btn-delete:hover {\n      background-color: #c0392b;\n    }\n\n    .btn-cancel,\n    .btn-label-select {\n      background-color: #f9f9f9;\n      color: #333;\n      margin-top: 0;\n      margin-left: 0;\n    }\n\n    .btn-cancel:hover,\n    .btn-label-select:hover {\n      background-color: #f1f1f1;\n    }\n\n    #tags {\n      width: calc(100% - 77px);\n    }\n\n    .error {\n      color: red;\n      font-size: 14px;\n      margin-top: 5px;\n      display: none;\n    }\n\n    input.invalid {\n      border-color: red;\n    }\n\n    .ad {\n      margin-bottom: 15px;\n      color: #666;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 10px;\n      border-left: 3px solid #007bff;\n      background-color: #f9f9f9;\n      border-radius: 4px;\n    }\n\n    #status {\n      font-size: 16px;\n    }\n\n    #saved-message {\n      position: absolute;\n      color: green;\n      top: 5px;\n      left: calc(50% - 50px);\n    }\n\n    #myForm,\n    #settings,\n    .ad,\n    #status,\n    #saved-message {\n      display: none;\n    }\n\n    .form-header {\n      position: relative;\n      margin-bottom: 15px;\n    }\n\n    .settings-btn,\n    .av-btn,\n    .search-btn {\n      position: absolute;\n      top: 0;\n      right: 0;\n      background: none;\n      border: none;\n      font-size: 20px;\n      cursor: pointer;\n      color: #666;\n      padding: 0;\n      width: 30px;\n      height: 30px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .av-btn {\n      right: 35px;\n    }\n\n    .search-btn {\n      right: 70px;\n    }\n\n    .settings-btn:hover,\n    .av-btn:hover {\n      color: #333;\n    }\n\n    #label-list,\n    #av-list {\n      position: absolute;\n      background-color: white;\n      border: 1px solid #ccc;\n      border-radius: 4px;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n      z-index: 1000;\n      display: none;\n      max-height: 260px;\n      overflow-y: auto;\n      width: 200px;\n    }\n\n    #av-list {\n      right: 35px;\n    }\n\n    #label-list div,\n    #av-list div {\n      padding: 8px 12px;\n      cursor: pointer;\n    }\n\n    #label-list div:hover,\n    #av-list div:hover {\n      background-color: #f5f5f5;\n    }\n\n    .not-show-form-tip {\n      display: none;\n      color: green;\n    }\n\n    #search {\n      display: none;\n      min-height: 470px;\n    }\n\n    #myForm.show,\n    #settings.show,\n    .ad.show,\n    #status.show,\n    #saved-message.show,\n    #search.show {\n      display: block;\n    }\n\n    .checkmark {\n      float: right;\n      pointer-events: none;\n    }\n\n    /*.settings-btn svg{\n      color: #262626;\n      fill: currentColor;\n    }*/\n    .settings-btn svg:hover,\n    .av-btn svg:hover,\n    .search-btn:hover {\n      opacity: 0.8;\n    }\n\n    /* === 新增：标签搜索样式（必要的样式，仅此处添加） === */\n    #label-list .label-search {\n      box-sizing: border-box;\n      width: 100%;\n      padding: 6px 8px;\n      border: none;\n      border-bottom: 1px solid #ddd;\n      outline: none;\n      font-size: 14px;\n      position: sticky;\n      top: 0;\n      background-color: white;\n      z-index: 1;\n    }\n\n    #label-search-list {\n      outline: none;\n      font-size: 14px;\n      background-color: white;\n      max-height: 410px;\n      overflow-y: auto;\n    }\n\n    #label-search-list .label-item {\n      padding: 12px;\n      cursor: pointer;\n      display: block;\n      border-bottom: 1px solid #ddd;\n    }\n\n    #label-search-list .label-item:first-child {\n      border-top: 1px solid #ddd;\n    }\n\n    #label-search-list .label-item:hover,\n    #label-search-list .label-item.highlighted {\n      background-color: #f0f6ff;\n      /* 保持与 hover 协调的浅色背景 */\n      font-weight: 600;\n    }\n\n    #label-list .label-item,\n    #av-list .label-item {\n      padding: 8px 12px;\n      cursor: pointer;\n      display: block;\n    }\n\n    /* 新增：键盘选中高亮样式（仅用于搜索交互） */\n    #label-list .label-item.active,\n    #av-list .label-item.active {\n      background-color: #f0f6ff;\n      /* 保持与 hover 协调的浅色背景 */\n      font-weight: 600;\n    }\n\n    /* === 新增结束 === */\n\n    #myForm .form-group:has(#linkIcon) {\n      display: none;\n    }\n  </style>\n</head>\n\n<body>\n  <div class=\"form-container\">\n    <!-- status -->\n    <div id=\"status\"></div>\n    <!-- ad -->\n    <div class=\"ad\">\n      推荐免费AI平台：\n      <a href=\"javascript:;\" onclick=\"utools.shellOpenExternal('https://cloud.siliconflow.cn/i/8kP68u0B')\"\n        style=\"color: #007bff; font-weight: bold;\">硅基流动</a>\n      &nbsp;&nbsp;\n      国外AI平台：\n      <a href=\"javascript:;\" onclick=\"utools.shellOpenExternal('https://api.gpt.ge/register?aff=GlNE')\"\n        style=\"color: #28a745; font-weight: bold;\">V-API</a>&nbsp;\n      <span style=\"color: #888; font-size: 13px;\">模型多、稳定快速，价格比官方更划算。</span>\n    </div>\n\n    <!-- 收藏表单 -->\n    <form id=\"myForm\">\n      <div class=\"form-header\">\n        <h2 style=\"margin: 0;\">网址收藏</h2>\n        <button type=\"button\" class=\"search-btn\" title=\"搜索\">\n          <svg t=\"1759714249029\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\"\n            p-id=\"4936\" width=\"24\" height=\"24\">\n            <path\n              d=\"M762.752 736.704a368 368 0 1 0-48 42.432l158.592 158.72a32 32 0 0 0 45.312-45.312l-155.904-155.84zM496 179.2a304 304 0 1 1 0 608 304 304 0 0 1 0-608z\"\n              fill=\"#263140\" p-id=\"4937\"></path>\n          </svg>\n        </button>\n        <button type=\"button\" class=\"av-btn\" title=\"数据库\">\n          <svg width=\"24\" height=\"24\" t=\"1759308148108\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\"\n            xmlns=\"http://www.w3.org/2000/svg\" p-id=\"10803\">\n            <path\n              d=\"M512 128c204.330667 0 371.370667 72.96 383.317333 164.992l0.554667 5.845333L896 725.333333c0 96.938667-168.533333 170.666667-384 170.666667s-384-73.728-384-170.666667V298.666667c5.802667-94.72 175.488-170.666667 384-170.666667z m320 480.128C763.776 653.696 647.125333 682.666667 512 682.666667c-129.493333 0-242.005333-26.624-311.210667-68.906667l-8.789333-5.632V725.333333c0 0.682667 0.085333 1.536 0.213333 2.474667l0.853334 3.285333 0.682666 1.92 2.048 4.309334c6.784 12.416 24.704 31.445333 69.290667 51.2C323.968 814.506667 410.666667 832 512 832s188.032-17.493333 246.912-43.52c44.586667-19.712 62.506667-38.741333 69.290667-51.157333l2.048-4.309334 0.682666-1.92 0.853334-3.285333L832 725.333333v-117.205333z m0-210.517333C763.221333 442.026667 645.546667 469.333333 512 469.333333s-251.221333-27.306667-320-71.722666V512c0 0.682667 0.085333 1.536 0.213333 2.474667l0.853334 3.285333 0.682666 1.92 2.048 4.309333c6.784 12.416 24.704 31.445333 69.290667 51.2C323.968 601.173333 410.666667 618.666667 512 618.666667s188.032-17.493333 246.912-43.52c44.586667-19.712 62.506667-38.741333 69.290667-51.157334l2.048-4.309333 0.682666-1.92 0.853334-3.285333L832 512V397.610667zM512 192c-98.986667 0-185.557333 18.474667-244.906667 45.653333-42.410667 19.370667-61.44 38.016-69.546666 50.944l-2.688 4.821334-1.706667 4.181333-0.554667 1.792-0.554666 2.986667v2.133333l0.469333 2.56 1.152 3.413333c4.522667 11.093333 20.565333 31.744 71.68 53.333334 59.52 25.173333 146.56 41.514667 246.656 41.514666 100.096 0 187.136-16.384 246.613333-41.514666 51.2-21.589333 67.2-42.24 71.722667-53.333334l1.152-3.413333 0.512-3.072-0.256-2.986667a24.746667 24.746667 0 0 0-0.853333-3.413333l-1.706667-4.181333-2.730667-4.821334c-8.106667-12.928-27.136-31.573333-69.546666-50.986666C697.6 210.474667 610.986667 192 512 192z\"\n              fill=\"#000000\" p-id=\"10804\"></path>\n          </svg>\n        </button>\n        <div id=\"av-list\">\n        </div>\n        <button type=\"button\" class=\"settings-btn\" title=\"设置\">\n          <svg t=\"1758885897830\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\"\n            p-id=\"5070\" width=\"24\" height=\"24\">\n            <path\n              d=\"M439.816 101.851c-8.631-16.952-28.007-25.48-46.337-20.396-70.066 19.435-133.165 55.501-184.82 103.628-12.909 12.028-16.413 31.094-8.623 46.926 5.374 10.92 8.414 23.234 8.414 36.376 0 45.555-36.833 82.347-82.1 82.347-0.381 0-0.762-0.003-1.142-0.008-17.691-0.253-33.448 11.147-38.74 28.031C73.159 421.209 66 466.344 66 513.078c0 30.844 3.118 61.001 9.07 90.156 4.1 20.082 22.714 33.816 43.111 31.808a83.069 83.069 0 0 1 8.169-0.399c45.267 0 82.1 36.791 82.1 82.346 0 20.276-7.254 38.74-19.334 53.086-13.177 15.649-12.423 38.718 1.748 53.472 52.742 54.916 119.403 96.417 194.376 118.784 20.888 6.231 42.918-5.408 49.543-26.174 10.616-33.275 41.714-57.212 78.217-57.212s67.601 23.937 78.217 57.212c6.625 20.766 28.655 32.405 49.543 26.174 74.973-22.367 141.634-63.868 194.376-118.784 14.17-14.755 14.924-37.823 1.748-53.471-12.08-14.346-19.334-32.811-19.334-53.087 0-45.554 36.834-82.346 82.1-82.346 2.773 0 5.496 0.135 8.169 0.399 20.397 2.008 39.011-11.726 43.111-31.808 5.951-29.155 9.07-59.312 9.07-90.156 0-46.734-7.16-91.869-20.468-134.323-5.292-16.884-21.049-28.285-38.741-28.031-0.379 0.005-0.76 0.008-1.141 0.008-45.266 0-82.1-36.792-82.1-82.347 0-13.142 3.04-25.456 8.414-36.376 7.79-15.832 4.286-34.898-8.623-46.926-51.655-48.127-114.754-84.193-184.82-103.628-18.33-5.084-37.706 3.444-46.337 20.396-13.648 26.806-41.357 44.97-73.184 44.97-31.827 0-59.536-18.164-73.184-44.97zM288.45 268.385c0-14.471-1.9-28.535-5.47-41.936 31.114-25.118 66.377-45.232 104.576-59.156 29.686 36.285 74.82 59.528 125.444 59.528 50.624 0 95.758-23.243 125.444-59.528 38.199 13.924 73.462 34.038 104.576 59.156a162.748 162.748 0 0 0-5.47 41.936c0 79.513 57.113 145.772 132.604 159.667 6.434 27.261 9.846 55.723 9.846 85.026 0 14.581-0.845 28.951-2.485 43.065-79.109 10.814-139.965 78.769-139.965 160.846 0 26.162 6.201 50.922 17.202 72.84-30.829 27.076-66.197 49.043-104.786 64.612-28.717-45.337-79.271-75.496-136.966-75.496-57.695 0-108.249 30.159-136.966 75.496-38.589-15.569-73.957-37.536-104.787-64.612 11.002-21.918 17.203-46.678 17.203-72.84 0-82.077-60.856-150.032-139.965-160.846A373.007 373.007 0 0 1 146 513.078c0-29.304 3.411-57.765 9.845-85.026 75.492-13.894 132.605-80.154 132.605-159.667zM513 336c-97.202 0-176 78.798-176 176s78.798 176 176 176 176-78.798 176-176-78.798-176-176-176zM409 512c0-57.438 46.562-104 104-104s104 46.562 104 104-46.562 104-104 104-104-46.562-104-104z\"\n              fill=\"#262626\" p-id=\"5071\"></path>\n          </svg>\n        </button>\n        <div id=\"saved-message\">✅本网址已收藏 <a id=\"view-saved\" href=\"javascript:;\">查看</a></div>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"title\">标题</label>\n        <input type=\"text\" id=\"title\" name=\"title\" required>\n        <div class=\"error\" id=\"title-error\">标题不能为空</div>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"link\">链接&nbsp;&nbsp;<a href=\"javascript:;\" id=\"btn-linkIcon\">显示图标</a><a id=\"btnReGet\"\n            href=\"javascript:;\" style=\"float:right;\">重新获取</a></label>\n        <input type=\"url\" id=\"link\" name=\"link\" required>\n        <div class=\"error\" id=\"link-error\">链接不能为空</div>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"linkIcon\">网站图标</label>\n        <input type=\"url\" id=\"linkIcon\" name=\"linkIcon\">\n      </div>\n      <div class=\"form-group\">\n        <label for=\"tags\">标签</label>\n        <input type=\"text\" id=\"tags\" name=\"tags\" value=\"\" placeholder=\"多个用逗号隔开，支持中文或英文逗号\">\n        <button type=\"button\" class=\"btn-label-select\">选择</button>\n        <div id=\"label-list\">\n          <input type=\"text\" class=\"label-search\" placeholder=\"搜索标签...\" />\n        </div>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"note\">摘要</label>\n        <textarea id=\"description\" name=\"description\"></textarea>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"note\">备注</label>\n        <textarea id=\"note\" name=\"note\"></textarea>\n      </div>\n      <button type=\"submit\" class=\"btn-save\">保存</button>\n      <button type=\"button\" class=\"btn-cancel\" id=\"btn-cancel\">关闭</button>\n      <button type=\"button\" class=\"btn-delete\" id=\"btn-delete\">删除</button>\n    </form>\n\n    <!-- 设置表单 -->\n    <form id=\"settings\">\n      <!-- 常规 设置部分 -->\n      <div class=\"form-header\" style=\"display: flex; align-items: center; gap: 10px;\">\n        <h2 style=\"margin: 0;\">设置</h2>\n        <div style=\"color:#666\">设置后在下次打开时生效</div>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"token\">思源Token</label>\n        <input type=\"password\" id=\"token\" name=\"token\" placeholder=\"请输入思源token，可在链滴-用户-设置-账号中查看\" required>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"token\">思源Api地址和端口</label>\n        <input type=\"text\" id=\"apiUrlPort\" name=\"apiUrlPort\" placeholder=\"url和端口之间用英文冒号隔开\" value=\"http://127.0.0.1:6806\"\n          required>\n      </div>\n      <div class=\"form-group\">\n        <label for=\"token\">思源收藏数据库ID（多个用英文或中文逗号隔开，默认使用第一个）</label>\n        <input type=\"text\" id=\"avIds\" name=\"avIds\" placeholder=\"可在块右键菜单中复制\" value=\"\" required>\n      </div>\n      <div class=\"form-group\">\n        <label>收藏面板，是否显示提交表单</label>\n        <label><input type=\"radio\" name=\"showRadio\" value=\"yes\" checked> 显示</label>\n        <label><input type=\"radio\" name=\"showRadio\" value=\"no\" id=\"notShowFormRadio\"> 不显示（直接保存）<span\n            class=\"not-show-form-tip\">可通过uTools“收藏网址配置”指令再次打开本设置</span></label>\n      </div>\n      <div class=\"form-group\">\n        <label>切换数据库时，是否显示确认框？</label>\n        <label><input type=\"checkbox\" id=\"onSwitchAvShowTips\" name=\"onSwitchAvShowTips\" checked> 显示确认框</label>\n      </div>\n      <div class=\"form-group\">\n        <label>重新获取时，是否显示确认框？</label>\n        <label><input type=\"checkbox\" id=\"onReGetShowTips\" name=\"onReGetShowTips\" checked> 显示确认框</label>\n      </div>\n      <div class=\"form-group\">\n        <label>是否支持从剪贴中板获取链接</label>\n        <label><input type=\"checkbox\" id=\"isGetLinkFromClipboard\" name=\"isGetLinkFromClipboard\" checked> 支持从剪贴中板获取</label>\n      </div>\n      <div class=\"form-group\">\n        <label>当搜索框内容为空时，是否默认显示topN收藏</label>\n        <label><input type=\"checkbox\" id=\"showTopNWhenSearchInputEmpty\" name=\"showTopNWhenSearchInputEmpty\" checked> 显示topN收藏</label>\n      </div>\n      <div class=\"form-group\">\n        <label>点击关闭按钮时，是否同时隐藏uTools主面板</label>\n        <label><input type=\"checkbox\" id=\"isHideUtoolsWhenClose\" name=\"isHideUtoolsWhenClose\" checked>\n          同时隐藏uTools主面板</label>\n      </div>\n      <div class=\"form-group\">\n        <label>是否自动抓取网页标签</label>\n        <label><input type=\"checkbox\" id=\"checkboxLabel\" name=\"checkboxLabel\" checked> 自动抓取标签</label>\n      </div>\n      <div class=\"form-group\">\n        <label>是否自动抓取摘要</label>\n        <label><input type=\"checkbox\" id=\"checkboxDescription\" name=\"checkboxDescription\" checked> 自动抓取摘要</label>\n      </div>\n      <div class=\"form-group\">\n        <label>是否抓取网站图标</label>\n        <label><input type=\"checkbox\" id=\"checkboxIcon\" name=\"checkboxIcon\" checked> 抓取网站图标</label>\n      </div>\n      <div class=\"form-group\">\n        <label>保存成功后是否显示通知</label>\n        <label><input type=\"checkbox\" id=\"checkboxShowNotification\" name=\"checkboxShowNotification\"> 显示通知</label>\n      </div>\n      <div class=\"form-group\">\n        <label>是否预抓取，并使用快捷命令服务存储信息</label>\n        <label><input type=\"checkbox\" id=\"checkboxQuickCommandServer\" name=\"checkboxQuickCommandServer\">\n          预抓取并使用快捷命令存储（该功能需要先安装油猴脚本和开启快捷命令服务）</label>\n      </div>\n\n      <!-- AI 设置部分 -->\n      <!-- <div class=\"form-header\">\n        <h2 style=\"margin: 0;\">AI 设置</h2>\n      </div>\n      <div style=\"margin-bottom: 15px;color:#666;\">用于生成文章摘要，不填则使用默认AI，为保证稳定性建议使用自己的API</div>\n      <div style=\"margin-bottom: 15px;color:#666;\">推荐免费AI平台：<a\n          href=\"https://cloud.siliconflow.cn/i/8kP68u0B\">硅基流动</a>&nbsp;&nbsp;&nbsp;&nbsp;国外AI平台：<a\n          href=\"https://api.gpt.ge/register?aff=GlNE\">V-API</a> 模型多稳定省心比官方划算</div>\n      <div class=\"form-group\">\n        <label for=\"api-url\">API URL</label>\n        <input type=\"text\" id=\"api-url\" name=\"api-url\" placeholder=\"\">\n      </div>\n      <div class=\"form-group\">\n        <label for=\"api-token\">API Token</label>\n        <input type=\"password\" id=\"api-token\" name=\"api-token\" placeholder=\"\">\n      </div>\n      <div class=\"form-group\">\n        <label for=\"api-model\">API Model</label>\n        <input type=\"text\" id=\"api-model\" name=\"api-model\" placeholder=\"\">\n      </div> -->\n\n      <button type=\"submit\" class=\"btn-save\">保存</button>\n      <button type=\"button\" class=\"btn-cancel\">关闭</button>\n    </form>\n\n    <form id=\"search\">\n      <div class=\"form-group\">\n        <label>搜索<a href=\"javascript:;\" id=\"btn-search-back\" style=\"float:right\">返回</a>&nbsp;&nbsp;</label>\n        <label><input type=\"text\" id=\"searchInput\" name=\"searchInput\" class=\"label-search\"\n            placeholder=\"请输入搜索关键词\"></label>\n      </div>\n      <div id=\"label-search-list\">\n      </div>\n    </form>\n  </div>\n  <template id=\"clipboard\">\n    <!--[[TEMPLATE-CLIPBOARD-DATA[[-->\n    {{ClipText}}\n    <!--]]TEMPLATE-CLIPBOARD-DATA]]-->\n  </template>\n\n  <script>\n    // 获取已存储配置\n    const config = quickcommand.userData.get(\"config\") || {};\n    // 获取输入文本\n    const input = `{{input}}`;\n    // 判断是否设置页面\n    const isConfigPage = `{{payload}}` === commandConfigName;\n    // 判断是否搜索页面\n    const isSearchPage = `{{payload}}` === commandSearchName;\n    // 是否显示表单，不显示表单则直接保存\n    const isShowForm = !config?.isShowFormVal || config?.isShowFormVal === 'yes' || isConfigPage || isSearchPage;\n    // 判断是否后台保存\n    const isBgSave = !isConfigPage && !isSearchPage && !isShowForm;\n\n    let apiUrlPort = 'http://127.0.0.1:6806';\n\n    let currentBrowserUrl = '';\n\n    let isBrowser = false;\n\n    config.autoLabel = config.autoLabel === undefined ? 'yes' : config.autoLabel;\n    config.autoDescription = config.autoDescription === undefined ? 'yes' : config.autoDescription;\n    config.showNotification = config.showNotification === undefined ? 'no' : config.showNotification;\n    config.addIcon = config.addIcon === undefined ? 'yes' : config.addIcon;\n    config.onSwitchAvShowTips = config.onSwitchAvShowTips === undefined ? 'yes' : config.onSwitchAvShowTips;\n    config.onReGetShowTips = config.onReGetShowTips === undefined ? 'yes' : config.onReGetShowTips;\n    config.isGetLinkFromClipboard = config.isGetLinkFromClipboard === undefined ? 'yes' : config.isGetLinkFromClipboard;\n    config.isHideUtoolsWhenClose = config.isHideUtoolsWhenClose === undefined ? 'yes' : config.isHideUtoolsWhenClose;\n    config.showTopNWhenSearchInputEmpty = config.showTopNWhenSearchInputEmpty === undefined ? 'yes' : config.showTopNWhenSearchInputEmpty;\n    config.avId = config.avId || config.avIds.split(/[,，]/).map(id => id.trim()).filter(Boolean)[0] || '';\n\n    async function main() {\n      try {\n        // 判断来源是收藏还是设置\n        const form = document.querySelector('#myForm');\n        const settings = document.querySelector('#settings');\n        const ad = document.querySelector('.ad');\n        const status = document.querySelector('#status');\n        const search = document.querySelector('#search');\n        const searchInput = document.querySelector('#searchInput');\n        if (isConfigPage) {\n          // 配置页面\n          ad.classList.add('show');\n          settings.classList.add('show');\n          form.classList.remove('show');\n          search.classList.remove('show');\n        } else if (isSearchPage) {\n          // 搜索页面\n          ad.classList.add('show');\n          search.classList.add('show');\n          settings.classList.remove('show');\n          form.classList.remove('show');\n          search.querySelector('#btn-search-back').style.display = 'none';\n          setTimeout(() => {\n            searchInput.focus();\n            searchInput.dispatchEvent(new InputEvent('input', { bubbles: true }));\n          }, 200);\n        } else if (isShowForm) {\n          // 显示表单页面\n          ad.classList.add('show');\n          form.classList.add('show');\n          settings.classList.remove('show');\n          search.classList.remove('show');\n        } else {\n          // 不显示表单页面(后台保存)\n          ad.classList.remove('show');\n          form.classList.remove('show');\n          settings.classList.remove('show');\n          search.classList.remove('show');\n          status.innerHTML = '正在保存...';\n          status.classList.add('show');\n        }\n\n        // 获取当前浏览器地址（兼容思源app）\n        let isValidUrl = true;\n        if (/^http/i.test(input)) {\n          currentBrowserUrl = input; // 主窗口输入\n        } else {\n          try {\n            // 浏览器窗口获取当前URL\n            currentBrowserUrl = await utools.readCurrentBrowserUrl();\n            //let currentBrowserUrl = utools.getCurrentBrowserUrl();\n            isBrowser = true;\n          } catch (e) {\n            // do nothing\n          }\n          // 尝试从剪切板获取\n          if (!currentBrowserUrl && config.isGetLinkFromClipboard === 'yes') {\n            const clipboardText = readClipboard();\n            if (clipboardText && /^http/i.test(clipboardText)) currentBrowserUrl = clipboardText;\n          }\n        }\n\n        if (!currentBrowserUrl && !isConfigPage && !isSearchPage) {\n          isValidUrl = false;\n          if (`{{payload}}` !== commandName) {\n            console.error('不是有效的URL');\n          }\n        }\n\n        // 初始化表单数据\n        if (!isConfigPage && !isSearchPage && isShowForm) {\n          // 获取表单标签\n          const avTags = await getAllTags(config.avId);\n          const tagListEl = document.querySelector(\"#label-list\");\n          avTags.forEach(tag => {\n            // <div data-label=\"娱乐\">娱乐</div>\n            const option = document.createElement('div');\n            option.setAttribute('data-label', tag);\n            option.textContent = tag;\n            option.className = 'label-item';\n            tagListEl.appendChild(option);\n          });\n        }\n        if (!isConfigPage && !isSearchPage && isShowForm && isValidUrl) {\n          // 表单提交页面获取数据\n          const getFormData = async (currentBrowserUrl, reGet = false) => {\n            const title = document.querySelector(\"#title\");\n            const tags = document.querySelector(\"#tags\");\n            const description = document.querySelector(\"#description\");\n            const link = document.querySelector(\"#link\");\n            const icon = document.querySelector(\"#linkIcon\");\n            const note = document.querySelector(\"#note\");\n            const btnReGet = document.querySelector(\"#btnReGet\");\n            if (reGet) {\n              document.querySelector(\"#saved-message\").classList.remove('show');\n              title.value = '';\n              tags.value = '';\n              description.value = '';\n              icon.value = '';\n              note.value = '';\n            }\n            document.querySelector(\"#link\").value = currentBrowserUrl;\n            const hasFavorite = await isExistLink(currentBrowserUrl);\n            if (hasFavorite) {\n              document.querySelector(\"#saved-message\").classList.add('show');\n            }\n            // 抓取网页信息\n            (async () => {\n              title.placeholder = '正在获取...';\n              if (config.autoLabel === 'yes') tags.placeholder = '正在获取...';\n              if (config.autoDescription === 'yes') description.placeholder = '正在获取...';\n              if (config.addIcon === 'yes') icon.placeholder = '正在获取...';\n              setTimeout(() => {\n                if (title.placeholder) title.placeholder = '';\n                if (config.autoLabel === 'yes' && tags.placeholder) tags.placeholder = '';\n                if (config.autoDescription === 'yes' && description.placeholder) description.placeholder = '';\n                if (config.addIcon === 'yes' && icon.placeholder) icon.placeholder = '';\n              }, 65000);\n              const docInfo = await getWebInfo(currentBrowserUrl);\n              const row = await getRowByLink(currentBrowserUrl);\n              if (!hasFavorite || !row) {\n                // 未收藏或数据库不存在行数据(添加表单)\n                if (docInfo.title) title.value = docInfo.title;\n                if (config.autoLabel === 'yes' && docInfo.keywords) tags.value = docInfo.keywords;\n                if (config.autoDescription === 'yes' && docInfo.description) description.value = docInfo.description;\n                if (config.addIcon === 'yes' && docInfo.icon) icon.value = docInfo.icon;\n                document.getElementById('btn-delete').style.display = 'none';\n              } else {\n                // 已收藏且存在行数据（更新表单）\n                document.getElementById('btn-delete').style.display = 'inline-block';\n                document.getElementById('btn-delete').dataset.id = row.id;\n                const cells = row.cells || row.values || [];\n                cells.forEach(cell => {\n                  if (cell.name === colsMaps.link) {\n                    cell.value[cell.valueType].forEach(cell => {\n                      if (cell.type === 'image') {\n                        icon.value = (config.addIcon ? docInfo.icon : '') || docInfo.icon || cell.content || '';\n                      } else {\n                        title.value = docInfo.title || cell.name || '';\n                      }\n                    });\n                  }\n                  if (cell.name === colsMaps.tags) {\n                    let tagList = cell.value[cell.valueType] || [];\n                    tagList = tagList.map(tag => tag.content);\n                    if (config.autoLabel === 'yes' && docInfo.keywords) {\n                      const webTags = docInfo.keywords.split(/[,，]/)?.map(tag => tag.trim())?.filter(tag => tag);\n                      webTags?.forEach(tag => {\n                        if (!tagList.includes(tag)) {\n                          tagList.push(tag);\n                        }\n                      });\n                    }\n                    tags.value = (tagList.join(',') || '') + (tags.value ? (',' + tags.value) : '');\n                  }\n                  if (cell.name === colsMaps.description) {\n                    const { content } = cell.value[cell.valueType];\n                    description.value = (config.autoDescription === 'yes' ? docInfo.description : '') || content || '';\n                  }\n                  if (cell.name === colsMaps.note) {\n                    const { content } = cell.value[cell.valueType];\n                    note.value = (content || '') + (note.value ? ('\\n' + note.value) : '');\n                  }\n                });\n              }\n              title.placeholder = '';\n              if (config.autoLabel === 'yes') tags.placeholder = '';\n              if (config.autoDescription === 'yes') description.placeholder = '';\n              if (config.addIcon === 'yes') icon.placeholder = '';\n              btnReGet.textContent = '重新获取';\n            })();\n          };\n          getFormData(currentBrowserUrl);\n          btnReGet.dataset.lastUrl = currentBrowserUrl;\n          link.addEventListener('input', (e) => {\n            e.preventDefault();\n            const newUrl = document.querySelector(\"#link\").value.trim();\n            if (!newUrl || !/^http/i.test(newUrl)) return;\n            if (newUrl === btnReGet.dataset.lastUrl) {\n              btnReGet.textContent = '重新获取';\n            } else {\n              btnReGet.textContent = '用新地址重新获取';\n            }\n          });\n          btnReGet.addEventListener('click', async (e) => {\n            e.preventDefault();\n            const newUrl = document.querySelector(\"#link\").value.trim();\n            if (!newUrl || !/^http/i.test(newUrl)) return;\n            if (config.onReGetShowTips === 'yes' && !(await quickcommand.showConfirmBox(\"重新获取当前已修改但未保存的数据将会丢失，确定继续吗？\", \"警告\", false, 450))) {\n              return;\n            }\n            btnReGet.dataset.lastUrl = newUrl;\n            getFormData(newUrl, true);\n          });\n        } else if (!isConfigPage && !isSearchPage && isValidUrl) {\n          // 后台保存收藏数据\n          const isExisted = await isExistLink(currentBrowserUrl);\n          if (isExisted) {\n            // 后台，已收藏，更新\n            if (!(await quickcommand.showConfirmBox(\"该网址已收藏，还要继续吗？\", \"提示\", false, 450))) {\n              utools.hideMainWindow();\n              utools.outPlugin();\n              return;\n            }\n            const docInfo = await getWebInfo(currentBrowserUrl);\n            const row = await getRowByLink(currentBrowserUrl);\n            const cells = row?.cells || row?.values || [];\n            const data = {\n              link: { name: '', content: currentBrowserUrl, icon: '' },\n              tags: '',\n              description: '',\n              note: '',\n              linkTitle: '',\n              linkUrl: currentBrowserUrl,\n            };\n            cells.forEach(cell => {\n              if (cell.name === colsMaps.link) {\n                cell.value[cell.valueType]?.forEach(cell => {\n                  if (cell.type === 'image') {\n                    data.link.icon = (config.addIcon ? docInfo.icon : '') || cell.content || '';\n                  } else {\n                    data.link.name = docInfo.title || cell.name || '';\n                    data.linkTitle = docInfo.title || cell.name || '';\n                  }\n                });\n              }\n              if (cell.name === colsMaps.tags) {\n                let tagList = cell.value[cell.valueType] || [];\n                tagList = tagList.map(tag => tag.content);\n                if (config.autoLabel === 'yes' && docInfo.keywords) {\n                  const webTags = docInfo.keywords.split(/[,，]/)?.map(tag => tag.trim())?.filter(tag => tag);\n                  webTags?.forEach(tag => {\n                    if (!tagList.includes(tag)) {\n                      tagList.push(tag);\n                    }\n                  });\n                }\n                data.tags = (tagList.join(',') || '');\n              }\n              if (cell.name === colsMaps.description) {\n                const { content } = cell.value[cell.valueType];\n                data.description = (config.autoDescription === 'yes' ? docInfo.description : '') || content || '';\n              }\n              if (cell.name === colsMaps.note) {\n                const { content } = cell.value[cell.valueType];\n                data.note = (content || '');\n              }\n            });\n            await saveData(data);\n          } else {\n            // 后台，未收藏，新增\n            const docInfo = await getWebInfo(currentBrowserUrl);\n            await saveData({\n              link: { name: docInfo.title || '', content: currentBrowserUrl, icon: (config.addIcon ? docInfo.icon : '') || '' },\n              tags: (config.autoLabel === 'yes' ? docInfo.keywords : '') || '',\n              description: (config.autoDescription === 'yes' ? docInfo.description : '') || '',\n              note: '',\n              linkTitle: docInfo.title || '',\n              linkUrl: currentBrowserUrl,\n            });\n          }\n        }\n        // 获取设置表单数据\n        document.querySelector('#token').value = config.token || '';\n        document.querySelector('#apiUrlPort').value = config.apiUrlPort || apiUrlPort;\n        apiUrlPort = config.apiUrlPort ? config.apiUrlPort : apiUrlPort;\n        document.querySelector('#avIds').value = config.avIds || '';\n        if (config.isShowFormVal === 'yes' || config.isShowFormVal === undefined) document.querySelector('#settings input[name=\"showRadio\"][value=\"yes\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"showRadio\"][value=\"no\"]').checked = true;\n        if (config.autoLabel === 'yes' || config.autoLabel === undefined) document.querySelector('#settings input[name=\"checkboxLabel\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"checkboxLabel\"]').checked = false;\n        if (config.autoDescription === 'yes' || config.autoDescription === undefined) document.querySelector('#settings input[name=\"checkboxDescription\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"checkboxDescription\"]').checked = false;\n        if (config.useQuickCommandServer === 'yes') document.querySelector('#settings input[name=\"checkboxQuickCommandServer\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"checkboxQuickCommandServer\"]').checked = false;\n        if (config.showNotification === 'yes' || config.showNotification === undefined) document.querySelector('#settings input[name=\"checkboxShowNotification\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"checkboxShowNotification\"]').checked = false;\n        if (config.addIcon === 'yes' || config.addIcon === undefined) document.querySelector('#settings input[name=\"checkboxIcon\"]').checked =\n          true;\n        else document.querySelector('#settings input[name=\"checkboxIcon\"]').checked = false;\n        if (config.onSwitchAvShowTips === 'yes' || config.onSwitchAvShowTips === undefined) {\n          document.querySelector('#settings input[name=\"onSwitchAvShowTips\"]').checked = true;\n        } else {\n          document.querySelector('#settings input[name=\"onSwitchAvShowTips\"]').checked = false;\n        }\n        if (config.onReGetShowTips === 'yes' || config.onReGetShowTips === undefined) {\n          document.querySelector('#settings input[name=\"onReGetShowTips\"]').checked = true;\n        } else {\n          document.querySelector('#settings input[name=\"onReGetShowTips\"]').checked = false;\n        }\n        if (config.isGetLinkFromClipboard === 'yes' || config.isGetLinkFromClipboard === undefined) {\n          document.querySelector('#settings input[name=\"isGetLinkFromClipboard\"]').checked = true;\n        } else {\n          document.querySelector('#settings input[name=\"isGetLinkFromClipboard\"]').checked = false;\n        }\n        if (config.isHideUtoolsWhenClose === 'yes' || config.isHideUtoolsWhenClose === undefined) {\n          document.querySelector('#settings input[name=\"isHideUtoolsWhenClose\"]').checked = true;\n        } else {\n          document.querySelector('#settings input[name=\"isHideUtoolsWhenClose\"]').checked = false;\n        }\n        if(config.showTopNWhenSearchInputEmpty === 'yes' || config.showTopNWhenSearchInputEmpty === undefined) {\n          document.querySelector('#settings input[name=\"showTopNWhenSearchInputEmpty\"]').checked = true;\n        } else {\n          document.querySelector('#settings input[name=\"showTopNWhenSearchInputEmpty\"]').checked = false;\n        }\n\n        // 设置提交\n        document.getElementById('settings').addEventListener('submit', function (e) {\n          e.preventDefault();\n          quickcommand.userData.put({\n            isShowFormVal: document.querySelector('#settings input[name=\"showRadio\"]:checked').value,\n            token: document.querySelector('#token').value,\n            apiUrlPort: document.querySelector('#apiUrlPort').value,\n            avIds: document.querySelector('#avIds').value,\n            autoLabel: document.querySelector('#settings input[name=\"checkboxLabel\"]').checked ? 'yes' : 'no',\n            autoDescription: document.querySelector('#settings input[name=\"checkboxDescription\"]').checked ? 'yes' : 'no',\n            useQuickCommandServer: document.querySelector('#settings input[name=\"checkboxQuickCommandServer\"]').checked ? 'yes' : 'no',\n            showNotification: document.querySelector('#settings input[name=\"checkboxShowNotification\"]').checked ? 'yes' : 'no',\n            onSwitchAvShowTips: document.querySelector('#settings input[name=\"onSwitchAvShowTips\"]').checked ? 'yes' : 'no',\n            onReGetShowTips: document.querySelector('#settings input[name=\"onReGetShowTips\"]').checked ? 'yes' : 'no',\n            isGetLinkFromClipboard: document.querySelector('#settings input[name=\"isGetLinkFromClipboard\"]').checked ? 'yes' : 'no',\n            addIcon: document.querySelector('#settings input[name=\"checkboxIcon\"]').checked ? 'yes' : 'no',\n            isHideUtoolsWhenClose: document.querySelector('#settings input[name=\"isHideUtoolsWhenClose\"]').checked ? 'yes' : 'no',\n            showTopNWhenSearchInputEmpty: document.querySelector('#settings input[name=\"showTopNWhenSearchInputEmpty\"]').checked ? 'yes' : 'no',\n          }, \"config\", false);\n          if (isConfigPage) {\n            if (config.isHideUtoolsWhenClose === 'yes') {\n              utools.hideMainWindow();\n            }\n            utools.outPlugin();\n          } else {\n            ad.classList.add('show');\n            form.classList.add('show');\n            settings.classList.remove('show');\n            quickcommand.showMessageBox(\"保存成功，将在下次打开时生效\", \"success\");\n          }\n        });\n\n        const avBtn = document.querySelector('.av-btn');\n        const avList = document.getElementById('av-list');\n\n        document.querySelector('.av-btn').addEventListener('click', async function (e) {\n          e.preventDefault();\n          if (avList.style.display === 'block') {\n            avList.style.display = 'none';\n          } else {\n            if (avList.children.length === 0) {\n              const avs = await getAvsByAvIds(config.avIds);\n              avs.forEach(av => {\n                // <div data-label=\"娱乐\">娱乐</div>\n                const option = document.createElement('div');\n                option.setAttribute('data-label', av.name);\n                option.setAttribute('data-id', av.id);\n                option.textContent = av.name;\n                option.className = 'label-item';\n                if (av.id === config.avId) {\n                  const span = document.createElement('span');\n                  span.textContent = ' ✓';\n                  span.className = 'checkmark';\n                  option.appendChild(span);\n                }\n                avList.appendChild(option);\n              });\n            }\n            avList.style.display = 'block';\n          }\n        });\n\n        // 切换数据库\n        avList.addEventListener('click', async function (e) {\n          if (e.target && e.target.hasAttribute('data-id')) {\n            const selectedLabelEl = e.target.closest('[data-id]');\n            const selectedLabelId = selectedLabelEl.getAttribute('data-id');\n            if (selectedLabelId === config.avId) return;\n            if (config.onSwitchAvShowTips === 'yes') {\n              if (!(await quickcommand.showConfirmBox(\"切换数据库当前已修改但未保存的数据将会丢失，确定继续吗？\", \"警告\", false, 450))) {\n                avList.style.display = 'none';\n                return;\n              }\n            }\n            avList.querySelector('span.checkmark').remove();\n            const span = document.createElement('span');\n            span.textContent = ' ✓';\n            span.className = 'checkmark';\n            selectedLabelEl.appendChild(span);\n            //config.avId = selectedLabelId;\n            // 重新配置avIds\n            const conf = quickcommand.userData.get(\"config\");\n            conf.avIds = reorderAvIdsStrict(conf.avIds, selectedLabelId.trim());\n            quickcommand.userData.put(conf, \"config\", false);\n            document.querySelector('#avIds').value = conf.avIds;\n            avList.style.display = 'none';\n            utools.redirect(commandName);\n          }\n        });\n\n        // 收藏表单提交\n        document.getElementById('myForm').addEventListener('submit', async function (e) {\n          e.preventDefault();\n\n          const title = document.getElementById('title');\n          const link = document.getElementById('link');\n          const tags = document.getElementById('tags');\n          const description = document.getElementById('description');\n          const note = document.getElementById('note');\n          const icon = document.getElementById('linkIcon');\n          const titleError = document.getElementById('title-error');\n          const linkError = document.getElementById('link-error');\n\n          let isValid = true;\n\n          // 验证标题\n          if (!title.value.trim()) {\n            title.classList.add('invalid');\n            titleError.style.display = 'block';\n            isValid = false;\n          } else {\n            title.classList.remove('invalid');\n            titleError.style.display = 'none';\n          }\n\n          // 验证链接\n          if (!link.value.trim()) {\n            link.classList.add('invalid');\n            linkError.style.display = 'block';\n            isValid = false;\n          } else {\n            link.classList.remove('invalid');\n            linkError.style.display = 'none';\n          }\n\n          // 如果所有验证通过，提交表单\n          if (isValid) {\n            await saveData({\n              link: { name: title.value || '', content: link.value || '', icon: icon.value || '' },\n              tags: tags.value || '',\n              description: description.value || '',\n              note: note.value || '',\n              linkTitle: title.value || '',\n              linkUrl: link.value || '',\n            });\n          }\n        });\n\n        document.getElementById(\"view-saved\").addEventListener('click', async function (e) {\n          e.preventDefault();\n          try {\n            const result = await querySql(`select id from blocks where markdown like '%data-av-id=\"${config.avId}\"%'`);\n            if (!result || result.length === 0) {\n              quickcommand.showMessageBox(\"未找到收藏文档，可能是块已被删除\", \"error\");\n              return;\n            }\n            utools.shellOpenExternal(`siyuan://blocks/${result[0].id}`);\n          } catch (error) {\n            console.error(error.message);\n          }\n        });\n\n        // 删除收藏\n        document.getElementById('btn-delete').addEventListener('click', async function (e) {\n          e.preventDefault();\n          if (await quickcommand.showConfirmBox(\"⚠️确认要删除吗？删除后不可恢复！\", \"警告\", false, 450)) {\n            const result = await requestApi(\"/api/av/removeAttributeViewBlocks\", {\n              \"avID\": config.avId,\n              \"srcIDs\": [\n                this.dataset.id\n              ]\n            });\n            if (!result || result.code !== 0) {\n              quickcommand.showMessageBox(result?.message || '删除失败', \"error\");\n              return;\n            }\n            if (config.showNotification === 'yes') quickcommand.showMessageBox('删除成功', \"success\");\n            if (config.isHideUtoolsWhenClose === 'yes') {\n              utools.hideMainWindow();\n            }\n            utools.outPlugin();\n          }\n        });\n\n        /////////////////////\n        // 搜索输入框事件\n        let isSearchInputComposing = false;\n        searchInput.addEventListener('compositionstart', () => {\n          isSearchInputComposing = true;\n        });\n        searchInput.addEventListener('compositionend', (e) => {\n          isSearchInputComposing = false;\n        });\n\n        let searchTimeoutId;\n        let highlightedIndex = -1; // 当前高亮项的索引\n        const searchList = document.querySelector('#label-search-list');\n\n        // 清除高亮样式\n        function clearHighlight() {\n          const items = searchList.querySelectorAll('.label-item');\n          items.forEach(item => item.classList.remove('highlighted'));\n          highlightedIndex = -1;\n        }\n\n        // 设置高亮项\n        function setHighlight(index, items) {\n          clearHighlight();\n          if(index < 0) index = 0;\n          if(index >= items.length) index = items.length - 1;\n          if (index >= 0 && index < items.length) {\n            items[index].classList.add('highlighted');\n            highlightedIndex = index;\n          }\n        }\n\n        searchInput.addEventListener('input', async (e) => {\n          if (searchTimeoutId) clearTimeout(searchTimeoutId);\n          searchTimeoutId = setTimeout(async () => {\n            if (isSearchInputComposing) return;\n            searchList.innerHTML = '';\n            clearHighlight(); // 重置高亮\n            const keywords = searchInput.value.trim();\n            //if (!keywords) return;\n\n            const links = keywords ? await searchLinks(keywords) : (config.showTopNWhenSearchInputEmpty === 'yes' ? await getTopN(defaultTopN||10) : []);\n            if (links.length === 0) return;\n\n            links.forEach(link => {\n              const option = document.createElement('div');\n              option.setAttribute('data-link', link.content);\n              option.textContent = link.name;\n              option.className = 'label-item';\n              option.title = link.remark || '';\n              option.onclick = () => {\n                utools.shellOpenExternal(link.content);\n              };\n              searchList.appendChild(option);\n            });\n          }, 100);\n        });\n\n        // 键盘导航\n        searchInput.addEventListener('keydown', (e) => {\n          const items = Array.from(searchList.querySelectorAll('.label-item'));\n          if (items.length === 0) return;\n\n          if (e.key === 'ArrowDown') {\n            e.preventDefault();\n            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);\n            setHighlight(highlightedIndex, items);\n            items[highlightedIndex] && items[highlightedIndex].scrollIntoView({ block: 'nearest' });\n          } else if (e.key === 'ArrowUp') {\n            e.preventDefault();\n            highlightedIndex = Math.max(highlightedIndex - 1, -1);\n            setHighlight(highlightedIndex, items);\n            items[highlightedIndex] && items[highlightedIndex].scrollIntoView({ block: 'nearest' });\n          } else if (e.key === 'Enter') {\n            e.preventDefault();\n            if (highlightedIndex >= 0 && highlightedIndex < items.length) {\n              const link = items[highlightedIndex].getAttribute('data-link');\n              utools.shellOpenExternal(link);\n            }\n          }\n        });\n        /////////////////////\n\n        // 图标按钮被点击\n        document.querySelector('#btn-linkIcon').addEventListener('click', async () => {\n          const linkIconGroup = document.querySelector('#myForm .form-group:has(#linkIcon)');\n          if (linkIconGroup?.style?.display === 'block') {\n            linkIconGroup.style.display = 'none';\n          } else {\n            linkIconGroup.style.display = 'block';\n          }\n        });\n\n        // 实时验证，当用户输入时清除错误状态\n        document.getElementById('title').addEventListener('input', function () {\n          if (this.value.trim()) {\n            this.classList.remove('invalid');\n            document.getElementById('title-error').style.display = 'none';\n          }\n        });\n\n        document.getElementById('link').addEventListener('input', function () {\n          if (this.value.trim()) {\n            this.classList.remove('invalid');\n            document.getElementById('link-error').style.display = 'none';\n          }\n        });\n\n        // 标签选择功能\n        const labelSelectBtn = document.querySelector('.btn-label-select');\n        const labelList = document.getElementById('label-list');\n        const tagsInput = document.getElementById('tags');\n        const settingsBtn = document.querySelector('.settings-btn');\n        const searchBtn = document.querySelector('.search-btn');\n\n        // 点击设置按钮显示设置表单\n        settingsBtn.addEventListener('click', function () {\n          document.getElementById('myForm').classList.remove('show');\n          document.getElementById('settings').classList.add('show');\n        });\n\n        // 点击搜索按钮显示搜索页面\n        searchBtn.addEventListener('click', function () {\n          document.getElementById('myForm').classList.remove('show');\n          document.getElementById('search').classList.add('show');\n          setTimeout(() => {\n            searchInput.focus();\n            if(!search.querySelector('#label-search-list').textContent.trim()) {\n              searchInput.dispatchEvent(new InputEvent('input', { bubbles: true }));\n            }\n          }, 100);\n        });\n\n        // 表单页面关闭\n        document.querySelector('#myForm .btn-cancel').addEventListener('click', function () {\n          if (config.isHideUtoolsWhenClose === 'yes') {\n            utools.hideMainWindow();\n          }\n          utools.outPlugin();\n        });\n\n        // 设置页面关闭\n        document.querySelector('#settings .btn-cancel').addEventListener('click', function () {\n          if (isConfigPage) {\n            if (config.isHideUtoolsWhenClose === 'yes') {\n              utools.hideMainWindow();\n            }\n            utools.outPlugin();\n          } else {\n            document.getElementById('settings').classList.remove('show');\n            document.getElementById('myForm').classList.add('show');\n          }\n        });\n\n        // 搜索返回页面\n        document.querySelector('#search #btn-search-back').addEventListener('click', function () {\n          if (isSearchPage) {\n            if (config.isHideUtoolsWhenClose === 'yes') {\n              utools.hideMainWindow();\n            }\n            utools.outPlugin();\n          } else {\n            document.getElementById('search').classList.remove('show');\n            document.getElementById('myForm').classList.add('show');\n          }\n        });\n\n        // 初始化列表数据\n        const initListData = () => {\n          // 清除所有已有对号\n          Array.from(labelList.querySelectorAll('[data-label]')).forEach(item => {\n            const check = item.querySelector('span.checkmark');\n            if (check) check.remove();\n          });\n\n          // 获取当前输入框中的标签\n          const currentTags = tagsInput.value.trim();\n          const tagsArray = currentTags.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag);\n\n          // 获取现有列表标签\n          const existingLabels = Array.from(labelList.querySelectorAll('[data-label]')).map(item => item.getAttribute('data-label'));\n\n          // 如果输入框里有新标签，添加到列表\n          tagsArray.forEach(tag => {\n            if (tag && !existingLabels.includes(tag)) {\n              const div = document.createElement('div');\n              div.setAttribute('data-label', tag);\n              div.textContent = tag;\n              div.className = 'label-item';\n              labelList.appendChild(div);\n            }\n          });\n\n          // 为已存在的标签添加对号\n          Array.from(labelList.querySelectorAll('[data-label]')).forEach(item => {\n            const label = item.getAttribute('data-label');\n            if (tagsArray.includes(label)) {\n              const span = document.createElement('span');\n              span.textContent = ' ✓';\n              span.className = 'checkmark';\n              item.appendChild(span);\n            }\n          });\n        };\n        initListData();\n\n        // === 新增：标签搜索功能（支持中文输入法） ===\n        const labelSearchInput = labelList.querySelector('.label-search');\n        let _isComposing = false;\n        function filterLabelList(query) {\n          const q = (query || '').trim().toLowerCase();\n          const items = labelList.querySelectorAll('.label-item');\n          items.forEach(item => {\n            const label = (item.getAttribute('data-label') || '').toLowerCase();\n            if (!q || label.indexOf(q) !== -1) {\n              item.style.display = 'block';\n            } else {\n              item.style.display = 'none';\n            }\n          });\n          // 过滤后重置选中索引\n          selectedIndex = -1;\n          updateActive(selectedIndex);\n        }\n        if (labelSearchInput) {\n          labelSearchInput.addEventListener('compositionstart', () => {\n            _isComposing = true;\n          });\n          labelSearchInput.addEventListener('compositionend', (e) => {\n            _isComposing = false;\n            filterLabelList(e.target.value);\n          });\n          labelSearchInput.addEventListener('input', (e) => {\n            if (!_isComposing) filterLabelList(e.target.value);\n          });\n          // 支持 Esc 清空并关闭\n          labelSearchInput.addEventListener('keydown', (e) => {\n            if (_isComposing) return;\n            if (e.key === 'Escape') {\n              labelSearchInput.value = '';\n              filterLabelList('');\n              labelList.style.display = 'none';\n              return;\n            }\n            // === 新增：上下键选择与回车选择 ===\n            const visibleItems = Array.from(labelList.querySelectorAll('.label-item')).filter(it => it.style.display !== 'none');\n            if (visibleItems.length === 0) return;\n            if (e.key === 'ArrowDown') {\n              e.preventDefault();\n              // 移动到下一个\n              if (selectedIndex < visibleItems.length - 1) {\n                selectedIndex++;\n              } else {\n                selectedIndex = 0;\n              }\n              // 映射 selectedIndex 到实际元素索引\n              updateActive(selectedIndex);\n              return;\n            }\n            if (e.key === 'ArrowUp') {\n              e.preventDefault();\n              if (selectedIndex > 0) {\n                selectedIndex--;\n              } else {\n                selectedIndex = visibleItems.length - 1;\n              }\n              updateActive(selectedIndex);\n              return;\n            }\n            if (e.key === 'Enter') {\n              e.preventDefault();\n              if (selectedIndex >= 0 && selectedIndex < visibleItems.length) {\n                const el = visibleItems[selectedIndex];\n                // 触发点击事件以复用已有逻辑\n                try {\n                  el.dispatchEvent(new MouseEvent('click', { bubbles: true }));\n                } catch (err) {\n                  // fallback: call click()\n                  try { el.click(); } catch (e) { /* ignore */ }\n                }\n              } else {\n                // 如果没有选中项，尝试匹配完全相等的标签并选择第一个\n                const q = (labelSearchInput.value || '').trim();\n                if (q) {\n                  const exact = Array.from(labelList.querySelectorAll('.label-item')).find(it => (it.getAttribute('data-label') || '') === q);\n                  if (exact) {\n                    try { exact.dispatchEvent(new MouseEvent('click', { bubbles: true })); } catch (e) { exact.click(); }\n                  }\n                }\n              }\n              return;\n            }\n            // === 新增结束 ===\n          });\n        }\n        // === 新增结束 ===\n\n        // 为键盘选中维护状态\n        let selectedIndex = -1;\n        function updateActive(idx) {\n          const visibleItems = Array.from(labelList.querySelectorAll('.label-item')).filter(it => it.style.display !== 'none');\n          // 清除所有 active\n          Array.from(labelList.querySelectorAll('.label-item')).forEach(it => it.classList.remove('active'));\n          if (idx >= 0 && idx < visibleItems.length) {\n            const el = visibleItems[idx];\n            el.classList.add('active');\n            // 尽量让元素可见\n            try { el.scrollIntoView({ block: 'nearest' }); } catch (e) { /* ignore */ }\n          } else {\n            selectedIndex = -1;\n          }\n        }\n\n        // 点击选择按钮显示标签列表\n        labelSelectBtn.addEventListener('click', function (e) {\n          if (labelList.style.display === 'block') {\n            labelList.style.display = 'none';\n            return;\n          }\n          const rect = labelSelectBtn.getBoundingClientRect();\n          labelList.style.top = rect.bottom + window.scrollY + 'px';\n          labelList.style.display = 'block';\n          labelList.style.left = rect.right - labelList.offsetWidth + window.scrollX + 'px';\n\n          initListData();\n          if (labelSearchInput) {\n            labelSearchInput.value = '';\n            filterLabelList('');\n            // 尽量把焦点放到搜索输入上（方便用户输入）\n            try { labelSearchInput.focus(); } catch (e) { /* ignore */ }\n          }\n        });\n\n        // 点击标签添加到输入框\n        labelList.addEventListener('click', function (e) {\n          if (e.target && e.target.hasAttribute('data-label')) {\n            const selectedLabelEl = e.target.closest('[data-label]');\n            const selectedLabel = selectedLabelEl.getAttribute('data-label');\n            const currentTags = tagsInput.value.trim();\n            const tagsArray = currentTags.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag);\n            // 如果点击的是对号，表示取消该标签\n            const checkmark = selectedLabelEl.querySelector('span.checkmark');\n            if (checkmark) {\n              const tag = selectedLabelEl.textContent.trim().replace('✓', '').trim();\n              checkmark.remove();\n              const index = tagsArray.indexOf(tag);\n              if (index > -1) {\n                tagsArray.splice(index, 1);\n              }\n              if (tagsArray.length === 0) {\n                tagsInput.value = '';\n              } else {\n                tagsInput.value = tagsArray.join(', ');\n              }\n              labelList.style.display = 'none';\n              return;\n            }\n            // 检查是否已存在该标签\n            if (!tagsArray.includes(selectedLabel)) {\n              if (currentTags === '') {\n                tagsInput.value = selectedLabel;\n              } else {\n                // 统一使用英文逗号分隔\n                tagsInput.value = currentTags.replace(/[,，]$/, '') + ', ' + selectedLabel;\n              }\n            }\n\n            labelList.style.display = 'none';\n          }\n        });\n\n        // 点击其他地方隐藏标签列表\n        document.addEventListener('click', function (e) {\n          if (!labelSelectBtn.contains(e.target) && !labelList.contains(e.target)) {\n            labelList.style.display = 'none';\n          }\n          if (!avBtn.contains(e.target) && !avList.contains(e.target)) {\n            avList.style.display = 'none';\n          }\n        });\n\n        const notShowFormRadio = document.getElementById('notShowFormRadio');\n        const tip = document.querySelector('.not-show-form-tip');\n        // 设置初始状态\n        tip.style.display = notShowFormRadio.checked ? 'inline' : 'none';\n        // 委托到父元素，监听 change 事件\n        document.querySelector('.form-group:has(#notShowFormRadio)').addEventListener('change', function (e) {\n          if (e.target.name === 'showRadio') {\n            tip.style.display = document.getElementById('notShowFormRadio').checked ? 'inline' : 'none';\n          }\n        });\n      } catch (e) {\n        console.error(e);\n      }\n    }\n    main();\n\n    // 抓取网页信息\n    async function getWebInfo(href) {\n      let json = { title: '', description: '', keywords: '', icon: '' };\n      const userAgent = \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36 Edg/116.0.1938.76\";\n\n      try {\n        let result;\n        // 先获取快捷命令服务\n        if (config.useQuickCommandServer && isBrowser && href.toLowerCase() === currentBrowserUrl.toLowerCase()) {\n          result = await forwardProxy(\n            `${quickCommandServerUrl.replace(/\\/$/, '')}/?r=${Date.now()}&action=getWebInfo`, 'GET', null,\n            [{ 'User-Agent': userAgent }],\n            10000, 'text/html'\n          );\n          if (result?.data?.body) {\n            try {\n              json = JSON.parse(result?.data?.body);\n              return json;\n            } catch (e) {\n              try {\n                json = JSON.parse(decodeURIComponent(result?.data?.body));\n                return json;\n              } catch (e) {\n                //consolelog(e.stack)\n              }\n            }\n          }\n        }\n\n        // 获取网络页面\n        result = await forwardProxy(\n          href, 'GET', null,\n          [{ 'User-Agent': userAgent }],\n          60000, 'text/html'\n        );\n\n        const data = result?.data;\n        if (!data || Math.floor(data.status / 100) !== 2) {\n          return json;\n        }\n\n        const html = data.body;\n        if (!html || typeof html !== 'string') {\n          return json;\n        }\n\n        // 1. 先用正则提取 head 标签部分\n        const headMatch = html.match(/<head[^>]*>([\\s\\S]*?)<\\/head>/i);\n        let headContent = headMatch ? headMatch[1] : html;\n\n        // 2. 用正则去除 script 和 style 标签及其内容\n        headContent = headContent\n          .replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '')\n          .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');\n\n        // 3. 构造一个完整的 HTML 文档用于 DOMParser 解析\n        const htmlDoc = `<!DOCTYPE html><html><head>${headContent}</head><body></body></html>`;\n\n        // 4. 使用 DOMParser 解析\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(htmlDoc, 'text/html');\n\n        // 5. 通过 DOM 方法获取元信息\n        // 获取 title\n        const titleElement = doc.querySelector('title');\n        if (titleElement) {\n          json.title = titleElement.textContent.trim();\n        }\n\n        // 获取 description\n        const descriptionMeta = doc.querySelector('meta[name=\"description\" i]') ||\n          doc.querySelector('meta[property=\"og:description\" i]');\n        if (descriptionMeta) {\n          json.description = (descriptionMeta.getAttribute('content') || '').trim();\n        }\n\n        // 获取 keywords\n        const keywordsMeta = doc.querySelector('meta[name=\"keywords\" i]');\n        if (keywordsMeta) {\n          json.keywords = (keywordsMeta.getAttribute('content') || '').trim();\n        }\n\n        // 6. HTML 解码\n        const decodeHtml = (str) => {\n          const textarea = document.createElement('textarea');\n          textarea.innerHTML = str;\n          return textarea.value;\n        };\n\n        json.title = decodeHtml(json.title);\n        json.description = decodeHtml(json.description);\n        json.keywords = decodeHtml(json.keywords)\n          ?.split(/[,，;；|\\s]+/)\n          ?.map(s => s.trim().toLowerCase())\n          ?.filter(Boolean)\n          ?.join(',');\n\n        // 新增：尝试解析网站图标（favicon）URL\n        try {\n          // 优先查找常见的 icon link 标签\n          const iconSelectorList = [\n            'link[rel*=\"icon\" i]',\n            'link[rel=\"shortcut icon\" i]',\n            'link[rel=\"apple-touch-icon\" i]',\n            'link[rel=\"apple-touch-icon-precomposed\" i]',\n            'link[rel=\"mask-icon\" i]'\n          ];\n          let foundHref = '';\n          for (let sel of iconSelectorList) {\n            const el = doc.querySelector(sel);\n            if (el && el.getAttribute && el.getAttribute('href')) {\n              foundHref = (el.getAttribute('href') || '').trim();\n              if (foundHref) break;\n            }\n          }\n          // 如果找到了 link href，规范化为绝对 URL\n          if (foundHref) {\n            // 处理 protocol-relative URL (e.g. //example.com/favicon.ico)\n            if (/^\\/\\//.test(foundHref)) {\n              try {\n                const u = new URL(href);\n                foundHref = u.protocol + foundHref;\n              } catch (e) {\n                // ignore\n              }\n            } else if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(foundHref)) {\n              // 相对路径，使用 base href 解析\n              try {\n                foundHref = new URL(foundHref, href).href;\n              } catch (e) {\n                // ignore\n              }\n            }\n            json.icon = foundHref || '';\n          } else {\n            // 回退：尝试使用站点根目录的 /favicon.ico\n            try {\n              const u = new URL(href);\n              json.icon = u.origin + '/favicon.ico';\n            } catch (e) {\n              json.icon = '';\n            }\n          }\n        } catch (e) {\n          console.error('favicon parse error', e);\n        }\n\n      } catch (error) {\n        console.error('Error fetching or parsing web info:', error);\n      }\n\n      return json;\n    }\n\n    // 保存数据\n    /*\n    data = {\n      link: {name: title.value, content: link.value},\n      tags: tags.value,\n      description: description.value,\n      note: note.value\n    }\n    */\n    async function saveData(data) {\n      try {\n        const keys = await requestApi(\"/api/av/getAttributeViewKeysByAvID\", {\n          avID: config.avId\n        });\n        if (!keys?.data) {\n          console.error('保存失败');\n          return;\n        }\n        let keyMap = {}, typeMap = {};\n        keys.data.forEach(key => {\n          if (key.type === 'mAsset' && key.name === colsMaps.link) { keyMap.link = key.id; typeMap.link = key.type; }\n          if (key.type === 'mSelect' && key.name === colsMaps.tags) { keyMap.tags = key.id; typeMap.tags = key.type; }\n          if (key.type === 'text' && key.name === colsMaps.description) { keyMap.description = key.id; typeMap.description = key.type; }\n          if (key.type === 'block' && key.name === colsMaps.note) { keyMap.note = key.id; typeMap.note = key.type; }\n          if (key.type === 'text' && key.name === colsMaps.linkTitle) { keyMap.linkTitle = key.id; typeMap.linkTitle = key.type; }\n          if (key.type === 'text' && key.name === colsMaps.linkUrl) { keyMap.linkUrl = key.id; typeMap.linkUrl = key.type; }\n        });\n        if (await isExistLink(data.link.content)) {\n          // 更新\n          const row = await getRowByLink(data.link.content);\n          let hasError = false;\n          const cells = row.cells || row.values || [];\n          for (const cell of cells) {\n            const contentMap = {\n              [colsMaps.description]: data.description,\n              [colsMaps.note]: data.note,\n              [colsMaps.linkTitle]: data.link.name,\n              [colsMaps.linkUrl]: data.link.content,\n            };\n            let content = {\n              \"content\": contentMap[cell.name] || cell.value[cell.valueType]?.content || '',\n            };\n            // 处理资源类型\n            if (cell.valueType === 'mAsset') {\n              content = [\n                {\n                  type: \"image\",\n                  name: '',\n                  content: data.link.icon || cell.value[cell.valueType]?.find(c => c.type === 'image')?.content || '',\n                },\n                {\n                  type: \"file\",\n                  name: data.link.name || cell.value[cell.valueType]?.find(c => c.type === 'file')?.name || '',\n                  content: data.link.content,\n                }\n              ];\n            }\n            if (cell.valueType === 'mSelect') {\n              const tags = cell.value[cell.valueType] || [];\n              const tagNames = tags.map(t => t.content);\n              const tagColors = tags.map(t => t.color).filter(t => t);\n              const webTags = (data.tags || '').split(/[,，]/).map(t => t.trim()).filter(t => t);\n              const getColor = createColorPicker(tagColors);\n              webTags.forEach(t => {\n                if (!tagNames.includes(t)) tags.push({ \"content\": t, \"color\": getColor() + '' });\n              });\n              content = tags;\n            }\n            const res = await requestApi(\"/api/av/setAttributeViewBlockAttr\", {\n              avID: config.avId,\n              keyID: cell.value.keyID,\n              itemID: row.id,\n              cellID: cell.value.id,\n              value: { [cell.valueType]: content },\n            });\n            if (!res || res.code !== 0) {\n              hasError = true;\n            }\n          }\n          if (hasError) {\n            console.error('有部分字段保存失败');\n            return;\n          }\n          if (config.showNotification === 'yes') utools.showNotification('✅保存成功');\n          utools.hideMainWindow();\n          utools.outPlugin();\n        } else {\n          // 新增\n          const values = [];\n          for (const [key, value] of Object.entries(data)) {\n            let content = { \"content\": value };\n            // 处理资源类型\n            if (typeMap[key] === 'mAsset') {\n              content = [\n                {\n                  type: \"image\",\n                  name: '',\n                  content: value.icon || '',\n                },\n                {\n                  type: \"file\",\n                  name: value.name || '',\n                  content: value.content || '',\n                }\n              ];\n            }\n            if (typeMap[key] === 'mSelect') {\n              const tags = (value || '').split(/[,，]/).map(t => t.trim()).filter(t => t);\n              let tagsContent = [];\n              const getColor = createColorPicker();\n              tags.forEach(tag => {\n                tagsContent.push({ \"content\": tag, \"color\": getColor() + '' });\n              });\n              content = tagsContent;\n            }\n            values.push({\n              \"keyID\": keyMap[key],\n              [typeMap[key]]: content\n            });\n          }\n          const input = {\n            \"avID\": config.avId,\n            \"blocksValues\": [values]\n          }\n          const result = await requestApi('/api/av/appendAttributeViewDetachedBlocksWithValues', input);\n          if (!result || result.code !== 0) {\n            console.error('保存失败', result);\n            return;\n          }\n          if (config.showNotification === 'yes') utools.showNotification('✅收藏成功');\n          utools.hideMainWindow();\n          utools.outPlugin();\n        }\n      } catch (e) {\n        console.error('保存失败', e.message);\n      }\n    }\n\n    // 获取收藏信息\n    async function isExistLink(link) {\n      const data = await requestApi('/api/av/renderAttributeView', {\n        \"id\": config.avId,\n        \"query\": link,\n        \"pageSize\": 1,\n      });\n      return (data?.data?.view?.rowCount || data?.data?.view?.cardCount) > 0;\n    }\n\n    // 获取顶部10条\n    async function getTopN(n = 10) {\n      return searchLinks('', n);\n    }\n\n    // 查询并返回链接列表\n    async function searchLinks(keywords, pageSize = 1000) {\n      const data = await requestApi('/api/av/renderAttributeView', {\n        \"id\": config.avId,\n        \"query\": keywords,\n        \"pageSize\": pageSize,\n      });\n      let rows = [];\n      if (data?.data?.view?.group) {\n        const links = [];\n        const groupList = data?.data?.view?.groups;\n        groupList.forEach(group => {\n          group.rows.forEach(row => {\n            const remark = row.cells.find(cell => cell.valueType === \"block\")?.value?.block?.content || '';\n            const linkCell = row.cells.find(cell => cell.valueType === \"mAsset\");\n            const link = linkCell.value[\"mAsset\"].find(c => c.type === 'file');\n            if (!links.includes(link.content)) {\n              link.remark = remark;\n              rows.push(link);\n              links.push(link.content);\n            }\n          });\n        });\n      } else {\n        const rowList = data?.data?.view?.rows || data?.data?.view?.cards;\n        rowList.forEach(row => {\n          const remark = (row.cells || row.values).find(cell => cell.valueType === \"block\")?.value?.block?.content || '';\n          const linkCell = (row.cells || row.values).find(cell => cell.valueType === \"mAsset\");\n          const link = linkCell.value[\"mAsset\"].find(c => c.type === 'file');\n          link.remark = remark;\n          rows.push(link);\n        });\n      }\n      return rows;\n    }\n\n    // 同时支持表格row.cells和卡片row.values和分组groups.rows\n    async function getRowByLink(link) {\n      const data = await requestApi('/api/av/renderAttributeView', {\n        \"id\": config.avId,\n        \"query\": link,\n        \"pageSize\": 1,\n      });\n      if (!(data?.data?.view?.rowCount || data?.data?.view?.cardCount)) return [];\n      const rowFiled = data?.data?.viewType === 'gallery' ? 'cards' : 'rows';\n      const columns = data?.data?.viewType === 'gallery' ? 'fields' : 'columns';\n      // 取查询到的第一条数据\n      let rows = data.data.view[rowFiled];\n      // 获取分组数据\n      if (data.data.view.group) {\n        const newRows = [];\n        for (const group of data.data.view.groups) {\n          if (group.rows.length) newRows.push(...group.rows);\n        }\n        rows = newRows;\n      }\n      // 获取置顶列行数据，这里是link列\n      const cols = data.data.view[columns];\n      const colName = colsMaps.link;\n      const colId = cols.find(c => c.name === colName)?.id;\n      const row = rows.find(r => (r.cells || r.values).find(c => c.value.keyID === colId));\n      if (!row) return [];\n      // 只保留需要的列\n      const colNames = Object.values(colsMaps);\n      const colIds = cols.filter(c => colNames.includes(c.name)).map(c => c.id);\n      row.cells = (row.cells || row.values).filter(c => colIds.includes(c.value.keyID));\n      const colIdNameMap = {};\n      cols.forEach(c => colIdNameMap[c.id] = c.name);\n      row.cells.forEach(c => c.name = colIdNameMap[c.value.keyID]);\n      return row;\n    }\n\n    // 获取常用标签\n    async function getAllTags(avId) {\n      const data = await requestApi('/api/av/renderAttributeView', {\n        \"id\": avId,\n        \"query\": \"\",\n        \"pageSize\": 1,\n      });\n      if (!data.data) return [];\n      return getTags(data);\n    }\n\n    function getTags(resp) {\n      const columns = resp.data.viewType === 'gallery' ? 'fields' : 'columns';\n      if (!resp || !resp.data || !resp.data.view || !Array.isArray(resp.data.view[columns])) return [];\n      const col = resp.data.view[columns].find(c => c.type === 'mSelect' && c.name === colsMaps.tags);\n      if (!col) return [];\n      if (!Array.isArray(col.options)) return [];\n      return col.options.map(opt => opt && opt.name).filter(Boolean);\n    }\n\n    function getAvsByAvIds(avIds) {\n      const ids = Array.isArray(avIds) ? avIds : avIds.split(/[,，]/).map(id => id.trim()).filter(Boolean);\n      if (ids.length === 0) return [];\n      const subQueries = ids.map(avId => `\n        SELECT\n          SUBSTR(TRIM(content), 1, INSTR(TRIM(content) || ' ', ' ') - 1) AS name,\n          '${avId}' AS id\n        FROM blocks\n        WHERE markdown LIKE '%data-av-id=\"${avId}\"%'\n      `);\n      const sql = subQueries.join(' UNION ALL ');\n      const result = querySql(sql);\n      return result;\n    }\n\n    // 通过思源代理访问，解决跨域问题\n    async function forwardProxy(url, method = 'GET', payload = {}, headers = [], timeout = 7000, contentType = 'text/html') {\n      const data = {\n        url: url,\n        method: method,\n        timeout: timeout,\n        contentType: contentType,\n        headers: headers,\n        payload: payload\n      };\n      return requestApi('/api/network/forwardProxy', data);\n    }\n\n    async function querySql(sql) {\n      const result = await requestApi('/api/query/sql', { \"stmt\": sql });\n      if (result.code !== 0) {\n        console.error(\"查询数据库出错\", result.msg);\n        return [];\n      }\n      return result.data;\n    }\n\n    // api请求\n    async function requestApi(url, data, method = 'POST') {\n      headers = { 'Content-Type': 'application/json' };\n      if (config?.token) headers['Authorization'] = 'token ' + config.token;\n      url = url.toLowerCase().startsWith('http') ? url : apiUrlPort.replace(/\\/+$/, '') + '/' + url.replace(/^\\/+/, '');\n      try {\n        return await (await fetch(url, {\n          method: method,\n          headers: headers,\n          body: JSON.stringify(data || {})\n        })).json();\n      } catch (e) {\n        throw new Error('请检查思源是否已正常启动！'+ e.message);\n      }\n    }\n\n    function createColorPicker(excludeColors = []) {\n      // 1-13 共13种颜色\n      let colors = Array.from({ length: 13 }, (_, i) => i + 1); // [1,2,...,13]\n      if (excludeColors.length < 13) {\n        // 排除已有颜色\n        colors = colors.filter(c => !excludeColors.includes(c + ''));\n      }\n      return function getRandColor() {\n        if (colors.length === 0) {\n          // 数组空了，重置\n          colors = Array.from({ length: 13 }, (_, i) => i + 1);\n        }\n\n        // 随机索引\n        const index = Math.floor(Math.random() * colors.length);\n        // 取出并删除该元素\n        const color = colors.splice(index, 1)[0];\n\n        return color;\n      };\n    }\n\n    function reorderAvIdsStrict(confAvIdsStr, targetId) {\n      const ids = confAvIdsStr.split(/[,，]/).map(id => id.trim()).filter(Boolean);\n\n      // 如果 targetId 不在原列表中，返回原列表（或报错/忽略）\n      if (!ids.includes(targetId)) {\n        return ids.join(','); // 或 throw new Error(`ID ${targetId} not found`);\n      }\n\n      const restIds = ids.filter(id => id !== targetId);\n      return [targetId, ...restIds].join(',');\n    }\n    function consolelog(args) {\n      console.log(JSON.stringify(args));\n      utools.copyText(JSON.stringify(args));\n    }\n    function readClipboard() {\n      const html = document.body.innerHTML;\n      // 匹配标记之间的内容\n      const regex = new RegExp('<!--\\\\[\\\\[TEMPLATE-CLIPBOARD-DATA\\\\[\\\\[-->([\\\\s\\\\S]*?)<!--\\\\]\\\\]TEMPLATE-CLIPBOARD-DATA\\\\]\\\\]-->', 'i');\n      const match = html.match(regex);\n      if (match && match[1] !== undefined) {\n        return match[1].trim();\n      }\n      return \"\";\n    }\n  </script>\n</body>\n\n</html>",
    "scptarg": "",
    "charset": {
        "scriptCode": "",
        "outputCode": ""
    },
    "customOptions": {
        "bin": "",
        "argv": "",
        "ext": ""
    },
    "cursorPosition": {
        "lineNumber": 27,
        "column": 28
    }
}